# 终止进程的运行

终止进程运行的四种方法：

- 主线程的进入点函数返回（最好）

- 进程中的一个线程调用了ExitProcess（避免）

- 另外一个进程中的线程调用了TerminateProcess（避免）

- 进程中的所有线程自行终止（几乎从未发生）

  ​

#### 主线程的进入点函数返回

好处：

1. 该线程创建的任何C++对象都能被它们的析构函数所释放

2. 操作系统能够正确的释放该线程的堆栈使用内存

3. 系统将进程的退出代码设置为进入点函数的返回值

4. 系统将进程内核对象返回值递减1

   ​

#### ExitProcess函数

只要进程中的一个线程调用了ExitProcess则进程终止运行。

如果在进入点函数中调用ExitThread，则主线程停止，如果存在其他线程在运行，则进程不会终止运行。

不能直接调用ExitProcess函数的原因是，当主线程结束时，C/C++运行期要进行资源的释放后才调用的ExitProcess，如果提前调用，C/C++运行期函数则无法释放资源。



#### TerminateProcess函数

```c++
BOOL	TerminateProcess(
  HANDLE	hProcess,
  UINT		fuExitCode
)
```

与ExitProcess的差别就是，ExitProcess是由本进程自己的线程所调用，TerminateProcess则可以由任何线程来调用。（一旦进程终止，系统不会将该进程的任何部分遗留下来，毫无蛛丝马迹）

有一种情况：调用了该函数，然后函数返回了，那么要终止的进程是否终止了呢？答案是不唯一的，因为该函数是异步函数，必须调用WaitForSingleObject或者类似函数传递进程句柄进行等待。（当检测到要终止的进程不存在任何运行的线程时，终止进程的运行，进程的退出代码被设置为与终止运行的最后一个线程相同的退出代码）



#### 终止进程时发生的情况

当进程终止运行时----------进程中剩余的所有线程全部终止运行-----所有用户对象和GDI对象被释放------所有内核对象被关闭---------进程的退出代码从STILL_ACTIVE改为传递给ExitProcess或者TerminateProcess的代码-----进程内核对象的状态变成收到通知状态--------进程内核对象的使用计数减一。



获取目前已经撤销的进程的退出代码

`BOOL	GetExitCodeProcess(HANDLE	hProcess,PDWORD	pdwExitCode);`

如果还没终止运行，则为STILL_ACTIVE