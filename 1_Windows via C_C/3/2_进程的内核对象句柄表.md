# 进程的内核对象句柄表

->	当进程被初始化时，系统为它分配一个句柄表，专门用于内核对象

->	句柄表的详细结构和管理并没有具体的资料说明

> 揭秘 句柄 句柄表

句柄表是句柄数组

句柄数据成员包括:内核对象内存块的指针、访问屏蔽标志位的DWORD、标志位DWORD

> 创建内核对象

->	进程初始化时，句柄表初始化，因此也是空的。

->	当进程中的线程调用创建内核对象的函数时（如CreateFileMapping）

->	内核就为该内核对象分配一个内存块（实例化并初始化）

->	接着，内核对进程的句柄表进行扫描，找出空的位置（未被使用的句柄)

->	然后对该句柄进行赋值，地址赋值为内核对象地址、访问屏蔽设置为全部访问权，设置标志位（后续讲到）等

> 值得注意

创建内核对象的函数一般返回句柄值，或者成功的句柄值，或者NULL或者INVALID_HANDLE_VALUE

注意，此句柄值非句柄表中的句柄中成员内核对象地址的值，而是句柄表中句柄存储的位置，因此该返回值

只是索引，因此句柄值非我们所讨论的句柄表中的句柄。

> 关闭内核对象

传递句柄值----是否越界，是否存在句柄----获取内核对象地址---查看是否计数为0

无效句柄？

两种情况，

一：进程运行正常，CloseHandle返回FALSE，GetLastError返回ERROR_INVALID_HANDLE

二：进程正在排查错误，系统通知调试程序

计数不为0？

不管是不是为0，该句柄肯定被移出句柄表了（清除操作）

不为0的话，没有关系，该内核对象被其他进程访问，最后会被其他进程的CloseHandle所检测。

> 注意

如果程序在终止运行时，句柄表非空，系统会全部清空，不会留下任何对象 （运行可能泄露  终止就肯定不会）

